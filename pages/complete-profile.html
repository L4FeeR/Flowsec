<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Completing Setup - Flowsec</title>
    <link rel="stylesheet" href="../css/auth.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous">
    <style>
        .setup-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
        }
        .setup-content {
            background: white;
            border-radius: 10px;
            padding: 40px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            text-align: center;
            max-width: 500px;
        }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4CAF50;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .success-icon {
            font-size: 64px;
            color: #4CAF50;
            margin-bottom: 20px;
        }
        .error-icon {
            font-size: 64px;
            color: #f44336;
            margin-bottom: 20px;
        }
        h2 {
            color: #333;
            margin-bottom: 10px;
        }
        p {
            color: #666;
            line-height: 1.6;
        }
        .btn {
            background: #4CAF50;
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 20px;
            text-decoration: none;
            display: inline-block;
        }
        .btn:hover {
            background: #45a049;
        }
    </style>
</head>
<body>
    <div class="setup-container">
        <div class="setup-content">
            <div class="spinner"></div>
            <h2>Setting Up Your Account...</h2>
            <p>Please wait while we complete your profile.</p>
        </div>
    </div>

    <script src="../js/config.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <script src="../js/supabase-client.js"></script>
    <script src="../js/encryption.js"></script>
    
    <script>
        async function completeProfile() {
            const setupContent = document.querySelector('.setup-content');
            
            try {
                console.log('=== PROFILE COMPLETION STARTED ===');

                // If the user arrived via magic link redirect, parse the session from the URL first
                // (Supabase returns access tokens in the URL after magic link flow)
                try {
                    const { data: urlSession, error: urlSessionError } = await supabaseClient.auth.getSessionFromUrl();
                    if (urlSessionError) {
                        // Not necessarily an error; session may already be present or no tokens in URL
                        console.log('No session token found in URL or already handled:', urlSessionError.message || urlSessionError);
                    } else {
                        console.log('Session established from URL:', urlSession);
                    }
                } catch (e) {
                    console.warn('getSessionFromUrl() threw an error (continuing):', e?.message || e);
                }

                // Get the current authenticated user
                const { data: { user }, error: userError } = await supabaseClient.auth.getUser();
                
                if (userError) {
                    throw new Error('Authentication failed: ' + userError.message);
                }
                
                if (!user) {
                    throw new Error('No authenticated user found. Please try signing up again.');
                }
                
                console.log('User authenticated:', user);
                console.log('üë§ User ID:', user.id);
                console.log('üìß User Email:', user.email);
                
                // Update status message
                setupContent.innerHTML = `
                    <div class="spinner"></div>
                    <h2>Generating Encryption Keys...</h2>
                    <p>üîê Creating your secure end-to-end encryption keys...</p>
                    <p style="font-size: 12px; opacity: 0.7;">User ID: ${user.id}</p>
                `;
                
                // Generate encryption keys (FRESH RANDOM KEYS for this user)
                console.log('üîê Generating NEW RSA key pair for user:', user.id);
                const keyPair = await EncryptionService.generateKeyPair();
                console.log('üé≤ Key pair generated - this should be unique!', keyPair);
                
                // Export public key for database
                const publicKeyBase64 = await EncryptionService.exportPublicKey(keyPair.publicKey);
                console.log('üì§ Public key exported (first 50 chars):', publicKeyBase64.substring(0, 50) + '...');
                
                // Generate fingerprint for verification
                const fingerprint = await EncryptionService.generateKeyFingerprint(keyPair.publicKey);
                console.log('üîë Key fingerprint:', fingerprint);
                
                // Get password from sessionStorage (stored during signup)
                const password = sessionStorage.getItem('pendingPassword') || user.email;
                console.log('üîê Using password for encryption:', password ? 'Yes' : 'No');
                
                // Store private key locally (encrypted with user's password)
                console.log('üíæ Storing private key locally with userId:', user.id);
                await EncryptionService.storePrivateKey(keyPair.privateKey, user.id, password);
                
                    // Hash password for server-side verification (store only the hash)
                    console.log('üîê Hashing password for secure storage (will store hash only)');
                    const passwordHash = await EncryptionService.hashPassword(password);
                    console.log('‚úÖ Password hashed (not storing plaintext)');
                
                // Also encrypt and prepare to upload to server
                console.log('‚òÅÔ∏è Encrypting private key for server backup...');
                const encryptedPrivateKey = await EncryptionService.encryptPrivateKeyForBackup(keyPair.privateKey, password);
                
                console.log('‚úÖ Encryption keys generated and stored');
                console.log('üìä LocalStorage key used:', `flowsec-privatekey-${user.id}`);
                
                // Get profile data from localStorage
                setupContent.innerHTML = `
                    <div class="spinner"></div>
                    <h2>Setting Up Your Profile...</h2>
                    <p>Almost there...</p>
                `;
                
                let name = localStorage.getItem('pendingName');
                let username = localStorage.getItem('pendingUsername');
                let gender = localStorage.getItem('pendingGender');
                const profilePicData = localStorage.getItem('pendingProfilePic');
                const email = localStorage.getItem('pendingEmail');
                
                console.log('Profile data from localStorage:', { name, username, gender, email });
                
                if (!username || !gender || !name) {
                    // Try to get from user metadata
                    const metaName = user.user_metadata?.name;
                    const metaUsername = user.user_metadata?.username;
                    const metaGender = user.user_metadata?.gender;
                    
                    if (!metaUsername || !metaGender || !metaName) {
                        throw new Error('Profile information missing. Please sign up again.');
                    }
                    
                    // Use metadata
                    name = metaName;
                    username = metaUsername;
                    gender = metaGender;
                    
                    console.log('Using metadata:', { name, username, gender });
                }
                
                let avatarUrl = null;
                
                // Upload profile picture if exists
                if (profilePicData) {
                    console.log('Uploading profile picture...');
                    try {
                        const blob = await fetch(profilePicData).then(r => r.blob());
                        const fileName = `${user.id}-${Date.now()}.jpg`;
                        
                        const { data: uploadData, error: uploadError } = await supabaseClient.storage
                            .from('profile-pics')
                            .upload(fileName, blob);
                        
                        if (uploadError) {
                            console.error('Profile picture upload error:', uploadError);
                        } else {
                            const { data: urlData } = supabaseClient.storage
                                .from('profile-pics')
                                .getPublicUrl(fileName);
                            avatarUrl = urlData.publicUrl;
                            console.log('Profile picture uploaded:', avatarUrl);
                        }
                    } catch (picError) {
                        console.error('Error processing profile picture:', picError);
                        // Continue without profile picture
                    }
                }
                
                // Check if profile already exists (trigger may have created it)
                const { data: existingProfile } = await supabaseClient
                    .from('profiles')
                    .select('*')
                    .eq('id', user.id)
                    .single();
                
                if (existingProfile) {
                    console.log('‚ö†Ô∏è Profile already exists (created by trigger)');
                    console.log('Existing profile:', existingProfile);
                    
                    // Check if it already has encryption keys
                    if (existingProfile.public_key && existingProfile.password_hash) {
                        console.log('‚úÖ Profile already complete with encryption keys');
                        
                        // Clear stored data
                        localStorage.removeItem('pendingName');
                        localStorage.removeItem('pendingUsername');
                        localStorage.removeItem('pendingGender');
                        localStorage.removeItem('pendingEmail');
                        localStorage.removeItem('pendingProfilePic');
                        sessionStorage.removeItem('pendingPassword');
                        
                        // Redirect to chat
                        window.location.href = 'chat.html';
                        return; // Stop execution
                    }
                    
                    console.log('üîÑ Updating existing profile with encryption keys and full data...');
                    
                    // Update existing profile with all the data
                    const { data: updatedProfile, error: updateError } = await supabaseClient
                        .from('profiles')
                        .update({
                            name: name,
                            username: username,
                            gender: gender,
                            avatar_url: avatarUrl,
                            public_key: publicKeyBase64,
                            key_fingerprint: fingerprint,
                            encrypted_private_key: encryptedPrivateKey,
                            password_hash: passwordHash,
                            updated_at: new Date().toISOString()
                        })
                        .eq('id', user.id)
                        .select()
                        .single();
                    
                    if (updateError) {
                        console.error('‚ùå Profile update failed', updateError);
                        throw new Error('Profile update failed: ' + (updateError.details || updateError.message));
                    }
                    
                    console.log('‚úÖ Profile updated successfully:', updatedProfile);
                    console.log('Verify updated fields:', {
                        hasUsername: !!updatedProfile.username,
                        hasPublicKey: !!updatedProfile.public_key,
                        hasEncryptedPrivateKey: !!updatedProfile.encrypted_private_key,
                        hasPasswordHash: !!updatedProfile.password_hash
                    });
                    
                } else {
                // Insert profile data with public key (trigger didn't create it yet)
                console.log('‚ú® Creating NEW profile with data:', { 
                    userId: user.id,
                    email: user.email,
                    name, 
                    username, 
                    gender, 
                    avatarUrl, 
                    publicKey: publicKeyBase64.substring(0, 30) + '...', 
                    fingerprint,
                    hasEncryptedPrivateKey: !!encryptedPrivateKey,
                    hasPasswordHash: !!passwordHash
                });
                
                console.log('Full insert object:', {
                    id: user.id,
                    email: user.email,
                    name: name,
                    username: username,
                    gender: gender,
                    avatar_url: avatarUrl,
                    public_key: publicKeyBase64 ? publicKeyBase64.substring(0, 50) + '...' : 'MISSING',
                    key_fingerprint: fingerprint || 'MISSING',
                    encrypted_private_key: encryptedPrivateKey ? encryptedPrivateKey.substring(0, 50) + '...' : 'MISSING',
                    password_hash: passwordHash ? passwordHash.substring(0, 50) + '...' : 'MISSING'
                });
                
                // Attempt to create profile row. Use .select().single() to get the created row back.
                const { data: profileData, error: profileError } = await supabaseClient
                    .from('profiles')
                    .insert({
                        id: user.id,
                        email: user.email,
                        name: name,
                        username: username,
                        gender: gender,
                        avatar_url: avatarUrl,
                        public_key: publicKeyBase64,
                        key_fingerprint: fingerprint,
                        encrypted_private_key: encryptedPrivateKey,
                        password_hash: passwordHash
                    })
                    .select()
                    .single();

                if (profileError) {
                    // Log full error for debugging and show details in the UI
                    console.error('‚ùå Profile creation failed', profileError);
                    // Provide more context in the thrown error so dev can see DB details
                    const details = profileError.details || profileError.message || JSON.stringify(profileError);
                    throw new Error('Profile creation failed: ' + details);
                }

                console.log('‚úÖ Profile created successfully:', profileData);
                console.log('Verify stored fields:', {
                    hasUsername: !!profileData.username,
                    hasPublicKey: !!profileData.public_key,
                    hasEncryptedPrivateKey: !!profileData.encrypted_private_key,
                    hasPasswordHash: !!profileData.password_hash
                });
                }
                
                // Clear stored data
                localStorage.removeItem('pendingName');
                localStorage.removeItem('pendingUsername');
                localStorage.removeItem('pendingGender');
                localStorage.removeItem('pendingProfilePic');
                localStorage.removeItem('pendingEmail');
                sessionStorage.removeItem('pendingPassword'); // Clear password from session storage
                
                // Show success message with encryption info
                setupContent.innerHTML = `
                    <div class="success-icon">‚úÖ</div>
                    <h2>All Set!</h2>
                    <p>Your account has been created successfully.</p>
                    <div style="background: #e8f5e9; padding: 15px; border-radius: 8px; margin: 15px 0;">
                        <p style="font-size: 14px; margin: 0;"><strong>üîê End-to-End Encryption Enabled</strong></p>
                        <p style="font-size: 12px; margin: 5px 0 0 0; color: #2e7d32;">Your messages are fully encrypted and secure!</p>
                    </div>
                    <p>Redirecting you to the chat...</p>
                `;
                
                // Redirect to chat after 2 seconds
                setTimeout(() => {
                    window.location.href = 'chat.html';
                }, 2000);
                
            } catch (error) {
                console.error('Profile completion error:', error);
                
                // Show error message
                setupContent.innerHTML = `
                    <div class="error-icon">‚ùå</div>
                    <h2>Setup Failed</h2>
                    <p>${error.message}</p>
                    <a href="signup.html" class="btn">Try Again</a>
                `;
            }
        }
        
        // Run profile completion when page loads
        window.addEventListener('DOMContentLoaded', completeProfile);
    </script>
</body>
</html>
